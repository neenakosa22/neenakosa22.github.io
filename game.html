import { useState, useEffect, useRef } from 'react';

export default function JumpGame() {
  const [gameState, setGameState] = useState('menu'); // menu, playing, gameOver
  const [player, setPlayer] = useState({
    x: 100,
    y: 200,
    velocityY: 0,
    isJumping: false
  });
  const [obstacles, setObstacles] = useState([]);
  const [score, setScore] = useState(0);
  const [highScore, setHighScore] = useState(0);
  const gameLoopRef = useRef();
  const keysRef = useRef({ space: false, up: false });

  const GRAVITY = 0.8;
  const JUMP_FORCE = -15;
  const GROUND_Y = 200;
  const GAME_SPEED = 3;

  // Handle keyboard input
  useEffect(() => {
    const handleKeyDown = (e) => {
      if (e.code === 'Space' || e.code === 'ArrowUp') {
        e.preventDefault();
        if (gameState === 'playing') {
          keysRef.current[e.code === 'Space' ? 'space' : 'up'] = true;
          jump();
        } else if (gameState === 'menu' || gameState === 'gameOver') {
          startGame();
        }
      }
    };

    const handleKeyUp = (e) => {
      if (e.code === 'Space' || e.code === 'ArrowUp') {
        keysRef.current[e.code === 'Space' ? 'space' : 'up'] = false;
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);

    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('keyup', handleKeyUp);
    };
  }, [gameState]);

  const jump = () => {
    setPlayer(prev => {
      if (prev.y >= GROUND_Y - 5) { // Only jump if on ground
        return {
          ...prev,
          velocityY: JUMP_FORCE,
          isJumping: true
        };
      }
      return prev;
    });
  };

  const startGame = () => {
    setGameState('playing');
    setPlayer({
      x: 100,
      y: GROUND_Y,
      velocityY: 0,
      isJumping: false
    });
    setObstacles([]);
    setScore(0);
  };

  const endGame = () => {
    setGameState('gameOver');
    if (score > highScore) {
      setHighScore(score);
    }
    if (gameLoopRef.current) {
      cancelAnimationFrame(gameLoopRef.current);
    }
  };

  // Game loop
  useEffect(() => {
    if (gameState !== 'playing') return;

    const gameLoop = () => {
      // Update player physics
      setPlayer(prev => {
        let newY = prev.y + prev.velocityY;
        let newVelocityY = prev.velocityY + GRAVITY;
        let newIsJumping = prev.isJumping;

        // Ground collision
        if (newY >= GROUND_Y) {
          newY = GROUND_Y;
          newVelocityY = 0;
          newIsJumping = false;
        }

        return {
          ...prev,
          y: newY,
          velocityY: newVelocityY,
          isJumping: newIsJumping
        };
      });

      // Update obstacles
      setObstacles(prev => {
        let newObstacles = prev.map(obstacle => ({
          ...obstacle,
          x: obstacle.x - GAME_SPEED
        })).filter(obstacle => obstacle.x > -50);

        // Add new obstacles
        if (newObstacles.length === 0 || newObstacles[newObstacles.length - 1].x < 600) {
          const types = ['cactus', 'rock', 'spike'];
          const type = types[Math.floor(Math.random() * types.length)];
          newObstacles.push({
            x: 800,
            y: GROUND_Y - (type === 'spike' ? 20 : 30),
            width: type === 'rock' ? 40 : 30,
            height: type === 'spike' ? 20 : 30,
            type: type
          });
        }

        return newObstacles;
      });

      // Update score
      setScore(prev => prev + 1);

      gameLoopRef.current = requestAnimationFrame(gameLoop);
    };

    gameLoopRef.current = requestAnimationFrame(gameLoop);

    return () => {
      if (gameLoopRef.current) {
        cancelAnimationFrame(gameLoopRef.current);
      }
    };
  }, [gameState]);

  // Collision detection
  useEffect(() => {
    if (gameState !== 'playing') return;

    const checkCollisions = () => {
      obstacles.forEach(obstacle => {
        if (
          player.x < obstacle.x + obstacle.width &&
          player.x + 40 > obstacle.x &&
          player.y < obstacle.y + obstacle.height &&
          player.y + 40 > obstacle.y
        ) {
          endGame();
        }
      });
    };

    checkCollisions();
  }, [player, obstacles, gameState]);

  const getObstacleEmoji = (type) => {
    switch (type) {
      case 'cactus': return '🌵';
      case 'rock': return '🪨';
      case 'spike': return '⚡';
      default: return '🌵';
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-400 to-blue-200 overflow-hidden relative">
      {/* Clouds */}
      <div className="absolute top-10 left-20 text-4xl animate-pulse">☁️</div>
      <div className="absolute top-16 right-32 text-3xl animate-pulse delay-1000">☁️</div>
      <div className="absolute top-8 right-64 text-5xl animate-pulse delay-2000">☁️</div>

      {/* Sun */}
      <div className="absolute top-8 left-96 text-6xl animate-spin" style={{ animationDuration: '20s' }}>☀️</div>

      {/* Game Area */}
      <div className="relative w-full h-screen">
        {/* Ground */}
        <div 
          className="absolute bottom-0 w-full bg-green-400 border-t-4 border-green-600"
          style={{ height: `${window.innerHeight - GROUND_Y - 100}px` }}
        >
          {/* Grass pattern */}
          <div className="flex text-2xl animate-pulse">
            {Array.from({ length: 50 }, (_, i) => (
              <span key={i} className="text-green-600">🌱</span>
            ))}
          </div>
        </div>

        {/* Player */}
        {gameState === 'playing' && (
          <div
            className={`absolute w-10 h-10 text-4xl transition-transform ${
              player.isJumping ? 'scale-110' : 'scale-100'
            }`}
            style={{
              left: player.x,
              top: player.y,
              transform: `rotate(${player.velocityY * 2}deg)`
            }}
          >
            🏃‍♂️
          </div>
        )}

        {/* Obstacles */}
        {gameState === 'playing' && obstacles.map((obstacle, index) => (
          <div
            key={index}
            className="absolute text-4xl"
            style={{
              left: obstacle.x,
              top: obstacle.y,
              width: obstacle.width,
              height: obstacle.height
            }}
          >
            {getObstacleEmoji(obstacle.type)}
          </div>
        ))}

        {/* Score */}
        {gameState === 'playing' && (
          <div className="absolute top-8 right-8 bg-white bg-opacity-90 rounded-lg p-4 shadow-lg">
            <div className="text-2xl font-bold text-gray-800">คะแนน: {Math.floor(score / 10)}</div>
            <div className="text-sm text-gray-600">สูงสุด: {Math.floor(highScore / 10)}</div>
          </div>
        )}

        {/* Menu Screen */}
        {gameState === 'menu' && (
          <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div className="bg-white rounded-3xl p-8 text-center shadow-2xl max-w-md">
              <h1 className="text-4xl font-bold text-gray-800 mb-4">🏃‍♂️ เกมกระโดด 🏃‍♂️</h1>
              <div className="text-gray-600 mb-6">
                <p className="mb-2">กดปุ่ม <span className="bg-gray-200 px-2 py-1 rounded">Space</span> หรือ <span className="bg-gray-200 px-2 py-1 rounded">↑</span> เพื่อกระโดด</p>
                <p className="mb-2">หลบสิ่งกีดขวางให้ได้มากที่สุด!</p>
                <p className="text-sm">💡 กดค้างไว้เพื่อกระโดดต่อเนื่อง</p>
              </div>
              <button
                onClick={startGame}
                className="bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full font-bold text-xl hover:from-green-600 hover:to-blue-600 transition-all transform hover:scale-105 shadow-lg"
              >
                เริ่มเกม!
              </button>
              {highScore > 0 && (
                <p className="mt-4 text-gray-600">คะแนนสูงสุด: {Math.floor(highScore / 10)}</p>
              )}
            </div>
          </div>
        )}

        {/* Game Over Screen */}
        {gameState === 'gameOver' && (
          <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div className="bg-white rounded-3xl p-8 text-center shadow-2xl max-w-md">
              <h2 className="text-4xl font-bold text-red-600 mb-4">💥 เกมจบแล้ว! 💥</h2>
              <div className="text-gray-700 mb-6">
                <p className="text-2xl font-bold mb-2">คะแนน: {Math.floor(score / 10)}</p>
                {score > highScore && (
                  <p className="text-green-600 font-bold mb-2">🎉 สถิติใหม่! 🎉</p>
                )}
                <p className="text-gray-600">คะแนนสูงสุด: {Math.floor(highScore / 10)}</p>
              </div>
              <div className="space-y-4">
                <button
                  onClick={startGame}
                  className="block w-full bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-4 rounded-full font-bold text-xl hover:from-green-600 hover:to-blue-600 transition-all transform hover:scale-105 shadow-lg"
                >
                  เล่นอีกครั้ง
                </button>
                <button
                  onClick={() => setGameState('menu')}
                  className="block w-full bg-gray-500 text-white px-8 py-3 rounded-full font-bold hover:bg-gray-600 transition-all"
                >
                  กลับเมนู
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Mobile Touch Button */}
        {gameState === 'playing' && (
          <button
            onTouchStart={(e) => {
              e.preventDefault();
              jump();
            }}
            className="absolute bottom-20 right-8 bg-yellow-500 hover:bg-yellow-600 text-white w-16 h-16 rounded-full font-bold text-2xl shadow-lg md:hidden flex items-center justify-center"
          >
            ⬆️
          </button>
        )}
      </div>

      {/* Instructions */}
      <div className="absolute bottom-4 left-4 text-white text-sm bg-black bg-opacity-50 rounded p-2">
        <p>🖥️ คีย์บอร์ด: Space หรือ ↑</p>
        <p>📱 มือถือ: แตะปุ่มเหลือง</p>
      </div>

      {/* Creator Credit */}
      <div className="absolute bottom-4 right-4 text-white text-sm bg-black bg-opacity-50 rounded p-2">
        <p>👨‍💻 สร้างโดย: Phatnaree Kosa No.10</p>
      </div>
    </div>
  );
}
